<!DOCTYPE HTML>
<html>
<head>
</head>
<body>
<div id="user-box">
    <input id="message">
</div>
<div id="chat"></div>
<script>
    var userBoxDiv = document.getElementById("user-box");
    var messageInput = document.getElementById("message");
    var chatDiv = document.getElementById("chat");

    var userName = prompt("Type your name", "satanus");

    var ws = new WebSocket("ws://localhost:8187");

    function sendUserName(userName) {
        ws.send("user_name:" + userName);
    }

    function deconstruct(message) {
        var key = message.slice(0, message.indexOf(":"));
        var value = message.slice(message.indexOf(":") + 1);
        return [key, value];
    }

    function buildSendButton(userName) {
        var button = document.createElement("button");
        button.innerHTML = "Send to " + userName;
        button.setAttribute("id", userName);
        userBoxDiv.appendChild(button);
    }

    function buildSendButtons(users) {
        var users = users.split(", ");
        for (index in users) {
            buildSendButton(users[index]);
        }
    }

    function constructRecord(userName, message) {
        return userName + ": " + message;
    }

    function addRecord(userName, message) {
        var record = constructRecord(userName, message);
        var p = document.createElement("p");
        p.appendChild("<pre>" + record + "</pre>");
        chatDiv.appendChild(p);
    }

    ws.onopen = function() {
        sendUserName(userName);
    };

    ws.onmessage = function(e) {
        data = deconstruct(e.data);
        var key = data[0];
        var value = data[1];
        console.log("key: " + key + "; value: " + value);
        switch (key) {
            case "users":
                var users = value;
                buildSendButtons(users);
                break;
            case "user_name":
                var sendFrom = value;
                break;
            case "message":
                var message = value;
                addRecord(sendFrom, message);
                break;
        }

        var sendButtons = document.getElementsByTagName("button");

        console.log(sendButtons);

        for (var i = 0; i < sendButtons.length; i++) {
            console.log(i);
            sendButtons[i].onclick = function(e) {
                console.log(userName);
                ws.send("user_name:" + userName);
//                var send_to = e.toElement.id;
//                ws.send("to:", send_to);
//                var message = messageInput.value;
//                ws.send("message:", message);
            }
        }
    };

    ws.onclose = function() { "WebSocket connection is closed"; };
</script>
</body>
</html>